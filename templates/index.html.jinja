<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ proj_name }}</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
        <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
    </head>
    <body>
        <!-- 通知栏 -->
        <article id="warning-notification" class="message is-warning hidden" style="width: 20vw">
            <div class="message-header">
                <p>Warning</p>
                <button class="delete" aria-label="delete"></button>
            </div>
            <div class="message-body" style="text-align: justify;">
                Hey Guys
            </div>
        </article>

        <!-- 模态框 -->
        <div id="setting" class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="modal-title">Setting</div>
                <div class="modal-item-container">
                    <label class="label">Nvidia API Key: </label>
                    <div class="control">
                        <input class="input token-input" type="text" placeholder="Text input">
                    </div>
                </div>
                <div class="control">
                    <button class="button is-primary" onclick="submitConfig(this)">Setup Complete</button>
                </div>
            </div>
            <button class="modal-close is-large" aria-label="close"></button>
        </div>

        {# <!-- 导航栏 -->
        <nav class="navbar" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="https://bulma.zcopy.site">
                    <img src="https://bulma.zcopy.site/images/bulma-logo.png" width="112" height="28">
                </a>
                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>
            <div id="navbarBasicExample" class="navbar-menu">
                <div class="navbar-start">
                    <a class="navbar-item">Home</a>
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">More</a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item">About</a>
                            <a class="navbar-item">Jobs</a>
                            <a class="navbar-item">Contact</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item">Report an issue</a>
                        </div>
                    </div>
                </div>
                <div class="navbar-end">
                    <div class="navbar-item">
                        <div class="buttons">
                            <a class="button is-primary"><strong>Sign up</strong></a>
                            <a class="button is-light">Log in</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav> #}

        <!-- 顶部导航栏 -->
        <div class="navigation">
            <div class="nav-head" onclick="window.location.href='/index'">
                {{ proj_name }}
            </div>
            <div class="nav-item-container">
                <div class="nav-item" onclick="window.location.href='/index'">Home</div>
                <div class="nav-item">About</div>
                <div class="nav-item" onclick="configSetting()">Settings</div>
                <!-- share 按钮 -->
                <div class="tooltip-container">
                    <div class="button-content">
                        <span class="text">Share</span>
                        <svg class="share-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path
                                d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92c0-1.61-1.31-2.92-2.92-2.92zM18 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM6 13c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm12 7.02c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z">
                            </path>
                        </svg>
                    </div>
                    <div class="tooltip-content">
                        <div class="social-icons">
                            <a href="#" class="social-icon twitter">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path
                                        d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z">
                                    </path>
                                </svg>
                            </a>
                            <a href="#" class="social-icon facebook">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path
                                        d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z">
                                    </path>
                                </svg>
                            </a>
                            <a href="#" class="social-icon linkedin">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path
                                        d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z">
                                    </path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提示 -->
        <div id="myhome" class="main-content is-screened">
            <div id="app-banner-container">
                <div id="app-banner" class="anim">
                    <span class="anim-type" data-text='["Welcome To AwesomeParser", "Let us have a chat"]'></span>
                </div>
            </div>
        </div>

        <!-- 切换 -->
        <div class="arrow-switch left-arrow" onclick="switchLeftPage(this)">
            <img src="{{ url_for('static', path='img/left-arrow.png') }}" alt="left" style="width: 100%; height: auto;">
        </div>
        <div class="arrow-switch right-arrow" onclick="switchRightPage(this)">
            <img src="{{ url_for('static', path='img/right-arrow.png') }}" alt="right" style="width: 100%; height: auto;">
        </div>

        {% if not init: %}
        <!-- 文件上传面板 -->
        <div id="myupload" class="main-content">
            <div id="file-upload-panel" class="panel acrylic">
                <div id="file-upload-container">
                    <div id="file-upload">
                        <div id="file-upload-tips" class="feature-tips">
                            <h1>Upload your awesome</h1>
                            <span>Select your awesome and I will parase it</span>
                        </div>
                        <div id="file-drop-zone">
                            <img src="{{ url_for('static', path='img/fileupload.svg') }}" alt="Upload" style="width: 25%; height: auto; margin: 10px;">
                            <div><span>Drag and drop files to upload</span></div>
                            <button class="button submit is-primary is-light" style="margin: 5px;" type="submit" onclick="selectFiles()">Select Files</button>
                        </div>
                        <div id="file-upload-record">
                            {# <!-- 文件上传状态显示 -->
                            <!-- <div class="upload-record" style="width:100%; display: flex; flex-direction: row; justify-content: space-between; text-align: center; align-items: center; margin: 5px;">
                                <button class="delete" style="flex-basis:5%; margin-right: 5%"></button>
                                <img src="{{ url_for('static', path='img/markdown.svg') }}" alt="markdown" style="flex-basis: 9%; width:9%; height: auto;">
                                <span style="flex-grow: 4">RAG-prompt.md</span>
                                <span style="flex-grow: 1">10KB</span>
                                <img src="{{ url_for('static', path='img/loading.gif') }}" alt="status" style="flex-basis:7%; width: 10%; height: auto; margin-left: 2%;">
                            </div> --> #}
                        </div>
                    </div>
                    <div id="file-upload-btn-container" style="width:100%">
                        <button class="button clear" style="border-radius: 8px" onclick="clearFiles()">Clear</button>
                        <a href="{{ url_for('chat', id=2, token=token) }}">
                            <button class="button submit is-primary" style="border-radius: 8px" onclick="uploadFiles()">Submit</button>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 每日论文面板 -->
        <div id="mydaily" class="main-content">
            <div id="daily-paper-panel" class="panel acrylic">
                <div id="daily-paper-tips" class="feature-tips">
                    <h1>正在加载今日论文，请稍后</h1>
                </div>
                <div id="paper-list">
                    <progress class="progress is-small is-primary" max="100">15%</progress>
                    {# <!-- debug -->
                    <div id="paper1" class="paper-record">
                        <span class="paper-title">Transformation equation for frames undergoing non-uniform acceleration such as SHM and rotational motion</span>
                        <div class="paper-digest">
                            Lorentz transformation equations provide us a set of relations between the spacetime co-ordinates as observed from two different inertial frames. In case, one of the frames is moving with a uniform rectilinear we have Rindlers transformation equations under such a situation. In the present work we extend the Rindlers equations to a situation where we have in general non-uniform acceleration. First we consider the non-inertial frame to undergo simple harmonic motion (SHM) and as a second case we consider the non-inertial frame to move uniformly along a circle. This set of transformation equations will have applications in various branches of Physics and in general in Astrophysics.
                        </div>
                        <div class="paper-tools">
                            <img class="paper-link" src="{{ url_for('static', path='img/link.svg') }}" alt="Upload">
                            <span>Source</span>
                        </div>
                    </div>
                    <div id="paper2" class="paper-record">
                        <span class="paper-title">Transformation equation for frames undergoing non-uniform acceleration such as SHM and rotational motion</span>
                        <div class="paper-digest">
                            Lorentz transformation equations provide us a set of relations between the spacetime co-ordinates as observed from two different inertial frames. In case, one of the frames is moving with a uniform rectilinear we have Rindlers transformation equations under such a situation. In the present work we extend the Rindlers equations to a situation where we have in general non-uniform acceleration. First we consider the non-inertial frame to undergo simple harmonic motion (SHM) and as a second case we consider the non-inertial frame to move uniformly along a circle. This set of transformation equations will have applications in various branches of Physics and in general in Astrophysics.
                        </div>
                        <div class="paper-tools">
                            <img class="paper-link" src="{{ url_for('static', path='img/link.svg') }}" alt="Upload">
                            <span>Source</span>
                        </div>
                    </div> #}
                </div>
            </div>
        </div>
        {% endif %}
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // typewriter 效果
        (function() {
            var Typewriter, type;
            Typewriter = class Typewriter {
                constructor($wrap) {
                    this.typeIt = this.typeIt.bind(this);
                    this.deleteIt = this.deleteIt.bind(this);
                    this.delayedDelete = this.delayedDelete.bind(this);
                    this.$wrap = $wrap;
                    this.$type = this.$wrap.find('.anim-type');
                    this.text = this.$type.data('text');
                    this.typeIt(this.text[0], true);
                }
                typeIt(string, bool) {
                    var i, j, len, letter, results, text;
                    text = string.split('');
                    results = [];
                    for (i = j = 0, len = text.length; j < len; i = ++j) {
                        letter = text[i];
                        results.push(((letter, i) => {
                            return setTimeout(() => {
                                this.$type.html(this.$type.html() + letter);
                                if (bool === true && i === string.length - 1) {
                                    return this.delayedDelete(i * 200 + 100);
                                }
                            }, 200 * i + 100);   // 打字设置慢些
                        })(letter, i));
                    }
                    return results;
                }
                deleteIt(bool) {
                    var currentText, i, j, len, letter, results;
                    currentText = this.$type.text();
                    if (currentText === this.text[1]) {
                        this.string = this.text[0];
                    } else {
                        this.string = this.text[1];
                    }
                    results = [];
                    for (i = j = 0, len = currentText.length; j < len; i = ++j) {
                        letter = currentText[i];
                        results.push(
                            (
                                (letter, i) => {
                                    return setTimeout(() => {
                                        this.$type.html(this.$type.html().slice(0, -1));
                                        if (bool === true && i === currentText.length - 1) {
                                            return this.delayedType(i * 100);
                                        }
                                    }, 100 * i);  // 删除设置快些
                                }
                            )(letter, i)
                        );
                    }
                    return results;
                }
                delayedDelete(delay) {
                    return setTimeout(() => {
                        return this.deleteIt(true);
                    }, delay + 100);
                }
                delayedType(delay) {
                    return setTimeout(() => {
                        return this.typeIt(this.string, true);
                    }, delay + 100);
                }
            };
            type = new Typewriter($('.anim'));
        }).call(this);
    </script>
    <script>
        var count = 0;
        var file_count = 0;
        var validFiles = [];

        /* 自定义文件对象绑定 id */
        function UploadedFiles(id, file) {
            this.id = id;
            this.file = file
        }

        /* 模态框相关 */
        function openModal(el) {
            el.classList.add('is-active');
        }

        function closeModal($el) {
            $el.classList.remove('is-active');
        }

        function closeAllModals() {
            (document.querySelectorAll('.modal') || []).forEach(($modal) => {
                closeModal($modal);
            });
        }

        // Add a click event on various child elements to close the parent modal
        (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
            const $target = $close.closest('.modal');
            $close.addEventListener('click', () => {
                closeModal($target);
            });
        });

        // Add a keyboard event to close all modals
        document.addEventListener('keydown', (event) => {
            if(event.key === "Escape") {
                closeAllModals();
            }
        });

        /* 上传用户配置 */
        function submitConfig() {
            let elem = document.getElementsByClassName('token-input')
            if (elem.length > 0) {
                elem = elem[0];
            }
            let key = elem.value;     // 获取输入框的值
            const xhr = new XMLHttpRequest();
            xhr.open("get", '/check?apikey=' + key, true);
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 300) {
                    console.log('GET 请求成功:', xhr.responseText);
                    rep = JSON.parse(xhr.responseText);
                    if (rep["valid"] === true) {
                        console.log(rep["token"]);
                        // 网页跳转
                        let link = document.createElement('a');
                        link.href += '/index/' + rep["token"];
                        console.log(link.href);
                        link.click();
                    }
                    else {
                        warn_message.innerHTML = `Invalid Key`;
                        showElem(notification);
                    }
                } else {
                    console.error('GET 请求出错:', xhr.statusText);
                }
            };
            xhr.onmessage = function (event) {
                console.log('收到消息:', event.data);
            }
            xhr.onerror = function () {
                console.error('请求无法完成');
            };

            xhr.send();
        }

        /* 点击 “设置” */
        function configSetting() {
            openModal(document.getElementById('setting'));
        }

        /* 切换 */
        function switchLeftPage() {
            {% if init %}
            openModal(document.getElementById('setting'));
            warn_message.innerHTML = `Please input your Nvidia API Key (Setting > API Key)`;
            showElem(notification);
            {% endif %}
            {% if not init %}
            let elem = document.getElementsByClassName("is-screened")[0];
            console.log(elem);
            elem.classList.remove("is-screened");
            if (elem.id === "mydaily") {
                home_page = document.getElementById("myhome");
                home_page.classList.add("is-screened");
            }
            else if (elem.id === "myhome") {
                upload_page = document.getElementById("myupload");
                upload_page.classList.add("is-screened");
            }
            // 显示右箭头
            elem = document.getElementsByClassName("right-arrow")[0];
            elem.style.zIndex = "4";
            elem = document.getElementsByClassName("left-arrow")[0];
            elem.style.zIndex = "1";
            {% endif %}
        }

        function switchRightPage() {
            {% if init %}
            openModal(document.getElementById('setting'));
            warn_message.innerHTML = `Please input your Nvidia API Key (Setting > API Key)`;
            showElem(notification);
            {% endif %}
            {% if not init %}
            let elem = document.getElementsByClassName("is-screened")[0];
            console.log(elem);
            elem.classList.remove("is-screened");
            if (elem.id === "myupload") {
                home_page = document.getElementById("myhome");
                home_page.classList.add("is-screened");
            }
            else if (elem.id === "myhome") {
                daily_page = document.getElementById("mydaily");
                daily_page.classList.add("is-screened");
            }
            // 显示右箭头
            elem = document.getElementsByClassName("left-arrow")[0];
            elem.style.zIndex = "4";
            elem = document.getElementsByClassName("right-arrow")[0];
            elem.style.zIndex = "1";
            {% endif %}
        }

        {% if not init %}
        /* 显示每日论文 */
        function displayDailyPaper(info) {
            // 显示 banner、 跳转等
            var tips = document.getElementById('daily-paper-tips');
            tips.textContent = ''
            tips.innerHTML += `<h1>Daily Paper</h1>
            <span>Here is your daily paper. To learn more, you can <a href="{{ url_for('chat', id=1, token=token) }}" class="web-link">click here</a> to talk with AI</span>`
            // 显示文档列表
            var lst = document.getElementById('paper-list');
            lst.textContent = ''
            if (!lst) {
                console.error('Element not found');
                return;
            }
            info.details.forEach(paper => {
                paper_record = `<div id="paper${count}" class="paper-record">
                    <span class="paper-title">${paper.title}</span>
                    <div class="paper-digest">
                        ${paper.summary}
                    </div>
                    <div class="paper-tools">
                        <a href="${paper.link}" class="paper-link">
                            <img class="paper-link-img" src="{{ url_for('static', path='img/link.svg') }}" alt="Upload">
                            <span>Source</span>
                        </a>
                    </div>
                </div>`
                count += 1;
                lst.innerHTML += paper_record;
                //paper.author
            });
        }

        /* 初始化 WebSocket 连接 */
        const infoload_socket = new WebSocket(`ws://${window.location.host}/{{ token }}/load`);
        infoload_socket.onopen = function () {
            console.log('加载 daily paper 的 WebSocket 连接已打开');
        };
        infoload_socket.onmessage = function (event) {
            try {
                const info = JSON.parse(event.data);
                //console.log('Received data:', data);
                displayDailyPaper(info);
            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        };
        infoload_socket.onclose = function (e) {
            console.log('加载 daily paper 的 WebSocket 连接已关闭: ', e.reason);
        };
        infoload_socket.onerror = function (err) {
            console.error('加载 daily paper 的 WebSocket 错误: ', err);
        };

        /* 是否包含重复文件 */
        function containsDuplicate(newFile) {
            // console.log(newFile)
            // console.log(validFiles)
            for (let i = 0; i < validFiles.length; i++) {
                file = validFiles[i].file
                if (file.name === newFile.name &&
                    file.size === newFile.size &&
                    file.type === newFile.type &&
                    file.lastModified === newFile.lastModified
                )
                {
                    return true;
                }
            }
            return false;
        }
        {% endif %}

        var notification = document.getElementById('warning-notification');
        var warn_message = document.querySelector('#warning-notification > div.message-body');

        /* 显示元素 */
        function showElem(elem) {
            if (!elem.classList.contains("show")) {
                elem.classList.add("show");
                setTimeout(function() {
                    elem.classList.replace("show", "hidden");   // 移除 'show' 类来隐藏元素
                }, 5000);                // 5000 毫秒 = 5 秒
            }
        }

        {% if init %}
        warn_message.innerHTML = `Please input your Nvidia API Key (Setting > API Key)`;
        showElem(notification);
        {% endif %}

        {% if not init %}
        /* 根据文件名称获取文件扩展名 */
        function getFileExtension(filename) {
            var parts = filename.split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }

        /* 文件大小、类型检查 */
        function validCheck(files) {
            const maxSize = 1 * 1024 * 1024 * 1024;     // 1GB
            // var maxSize = 1 * 1024
            const maxNum = 5;
            const validExts = ["md", "txt"];
            if (files.length > 0) {
                for (var file of files) {
                    // 1. 限制扩展名
                    if (!validExts.includes(getFileExtension(file.name))) {
                        warn_message.innerHTML = `The file you upload must be in .md or .txt format`;
                        showElem(notification);
                        return
                    }
                    // 2. 限制文件上传个数
                    if (validFiles.length > maxNum) {
                        warn_message.innerHTML = `The number of files cannot exceed ${maxNum}`;
                        showElem(notification);
                        return
                    }
                    // 3. 限制文件上传大小
                    if (file.size > maxSize) {
                        warn_message.innerHTML = `File size cannot exceed ${formatFileSize(maxSize)}`;
                        showElem(notification);
                        continue;
                    }
                    // 4. 限制重复上传
                    if (containsDuplicate(file)) {
                        warn_message.innerHTML = `The file ${file.name} has been uploaded. Please do not upload it again.`;
                        showElem(notification);
                        continue;
                    }
                    validfile = new UploadedFiles(file_count, file);
                    //console.log(validfile)
                    validFiles.push(validfile);
                    records.innerHTML += `<div id="upload-record${file_count}" class="upload-record" style="width:100%; display: flex; flex-direction: row; justify-content: space-between; text-align: center; align-items: center; margin: 5px;">
                        <button class="delete" style="flex-basis:5%; margin-right: 5%" onclick="deleteFile(this)"></button>
                        <img src="{{ url_for('static', path='img/markdown.svg') }}" alt="markdown" style="flex-basis: 9%; width:9%; height: auto;">
                        <span style="flex-grow: 4">${file.name}</span>
                        <span style="flex-grow: 1">${formatFileSize(file.size)}</span>
                        <img src="{{ url_for('static', path='img/loading.gif') }}" alt="status" style="flex-basis:7%; width: 10%; height: auto; margin-left: 2%;">
                    </div>`;
                    file_count += 1;
                };
            }
        }


        /* 文件大小格式化 */
        function formatFileSize(size) {
            var units = ['B', 'KB', 'MB', 'GB', 'TB'];
            var i = 0;
            while (size >= 1024 && i < units.length - 1) {
                size /= 1024;
                i++;
            }
            return size.toFixed(2) + ' ' + units[i];
        }


        /* 文件选择 */
        function selectFiles() {
            let input = document.createElement('input');
            input.type = 'file';
            input.multiple = true; // 设置 multiple 属性以支持多文件选择
            input.onchange = _ => {
                // you can use this method to get file and perform respective operations
                files =  Array.from(input.files);
                validCheck(files);
            };
            input.click();   // 触发点击事件以打开文件选择对话框
        }


        /* 文件拖放 */
        const dropZone = document.getElementById('file-drop-zone');
        const records = document.getElementById('file-upload-record');
        if (window.FileList && window.File) {
            dropZone.addEventListener('dragover', event => {
                event.stopPropagation();
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
            });
            dropZone.addEventListener('drop', event => {
                event.stopPropagation();
                event.preventDefault();
                validCheck(event.dataTransfer.files);
            });
        }

        {# // /* 文件读取并上传 */
        // const reader = new FileReader();
        // reader.addEventListener(
        //     "load",
        //     event => {
        //         var formData = new FormData();
        //         formData.append('file', event);
        //         console.log(reader.result)
        //     },
        //     false,
        // );
        // /* 文件读取 */
        // function readFile(file) {
        //     const reader = new FileReader();
        //     reader.addEventListener('load', (event) => {
        //         const result = event.target.result;
        //         // Do something with result
        //     });

        //     reader.addEventListener('progress', (event) => {
        //         if (event.loaded && event.total) {
        //         const percent = (event.loaded / event.total) * 100;
        //         console.log(`Progress: ${Math.round(percent)}`);
        //         }
        //     });
        //     reader.readAsDataURL(file);
        //     return reader.result
        // } #}

        /* TODO: 文件上传 */
        async function uploadFiles() {
            var formData = new FormData();
            if (validFiles.length === 0) {
                warn_message.innerHTML = `You have not uploaded any files`;
                showElem(notification);
                return;
            }
            // 上传
            for (const validfile of validFiles) {
                file = validfile.file
                formData.append('files', file)
            }
            const xhr = new XMLHttpRequest();
            xhr.open("post", '/{{token}}/upload');
            xhr.send(formData);
        }

        /* 文件删除 */
        function deleteFile(elem) {
            var parent = elem.parentNode;
            var recordId = parent.id.substring(13);
            recordId = parseInt(recordId, 10);
            // 网页删除元素
            if (parent) {
                var pparent = parent.parentNode;   // 获取元素的父元素
                pparent.removeChild(parent);       // 从父元素中删除该元素
            }
            // 数组中删除
            validFiles = validFiles.filter(file => file.id !== recordId);
            // debug
            console.log(validFiles);
        }

        /* 清空上传文件列表 */
        function clearFiles() {
            validFiles = [];
            records.innerHTML = '';
        }
        {% endif %}
    </script>
</html>